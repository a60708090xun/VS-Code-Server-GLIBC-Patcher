# VS Code Server GLIBC Patcher

## Purpose

This script provides a workaround for running modern versions of VS Code Server on older Linux distributions that have an outdated GLIBC (e.g., GLIBC \< 2.28). It works by using `patchelf` and a custom-built GLIBC toolchain to patch the server executable on the fly.

The script automates the "Swap Method," where the original VS Code Server executable is replaced by a wrapper script. This wrapper sets the necessary environment variables before launching the original server, allowing it to run successfully.

## Prerequisites

Before using this script, you must have the following available on the remote host:

1.  A custom GLIBC toolchain (version \>= 2.28).
2.  The `patchelf` binary installed and available in your `PATH` or at a known location.

## The `auto_patch_vscode.sh` Script

```bash
#!/bin/bash
#
# Automatically patch the VS Code Server to use a custom GLIBC toolchain

set -e # Exit immediately if a command exits with a non-zero status.

# --- Configure your paths here ---
GLIBC_LINKER="/pool2/chenhsun/toolchain-dir/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib/ld-linux-x86-64.so.2"
GLIBC_PATH="/pool2/chenhsun/toolchain-dir/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib"
PATCHELF_PATH="/usr/local/bin/patchelf"
# ---------------------------------

VSCODE_DIR="$HOME/.vscode-server"

echo "Searching for VS Code Server directory: $VSCODE_DIR"
if [ ! -d "$VSCODE_DIR" ]; then
    echo "Error: VS Code Server directory not found at $VSCODE_DIR."
    echo "Please try to connect with VS Code Remote-SSH at least once to download the server files."
    exit 1
fi

# Find the target executable (filename format is 'code-<commit-hash>')
# -type f : Ensures it's a file
# -executable : Ensures it's an executable file
# ! -name '*.original' : Excludes our own backup files
TARGET_FILE=$(find "$VSCODE_DIR" -name 'code-*' -type f -executable ! -name '*.original' | head -n 1)

if [ -z "$TARGET_FILE" ]; then
    echo "Error: Could not find the VS Code Server executable in $VSCODE_DIR."
    echo "The server's structure might have changed, or it has not been downloaded yet."
    exit 1
fi

echo "Found target server file: $TARGET_FILE"

ORIGINAL_FILE="${TARGET_FILE}.original"

# Check if it has already been patched
if [ -f "$ORIGINAL_FILE" ]; then
    echo "Already patched. No action needed."
    exit 0
fi

echo "Not patched yet. Starting backup and wrap process..."

# 1. Back up the original file
mv "$TARGET_FILE" "$ORIGINAL_FILE"
echo "Original file backed up to: $ORIGINAL_FILE"

# 2. Create the new wrapper script (with the same name as the original file)
#    Using 'cat <<EOF' is a clean way to write a multi-line string to a file.
cat <<EOF > "$TARGET_FILE"
#!/bin/bash
#
# VS Code Server Wrapper Script (auto-generated by auto_patch_vscode.sh)

export VSCODE_SERVER_CUSTOM_GLIBC_LINKER="$GLIBC_LINKER"
export VSCODE_SERVER_CUSTOM_GLIBC_PATH="$GLIBC_PATH"
export VSCODE_SERVER_PATCHELF_PATH="$PATCHELF_PATH"

# Execute our backed-up original file, passing along all arguments
exec "$(dirname "\$0")/${ORIGINAL_FILE##*/}" "\$@"
EOF

# 3. Make the new script executable
chmod +x "$TARGET_FILE"

echo "Successfully created wrapper script: $TARGET_FILE"
echo "Patching complete! You can now try to connect from VS Code."
```

## How to Use

1.  **Configure the Script:** Open the `auto_patch_vscode.sh` script and edit the three variables in the "Configure your paths here" section to match your environment.

2.  **Upload the Script:** Place the `auto_patch_vscode.sh` file in the home directory of your user on the remote host (e.g., `~/auto_patch_vscode.sh`).

3.  **Make it Executable:** Log into your remote host via a standard SSH terminal and run the following command:

    ```bash
    chmod +x ~/auto_patch_vscode.sh
    ```

## When to Run This Script

The workflow is now very simple:

#### First-Time Setup

1.  Attempt to connect with VS Code once. The connection will fail, but this is necessary to download the server files.
2.  On the remote host, run the script: `./auto_patch_vscode.sh`.
3.  Done\! VS Code should now be able to connect successfully.

#### After a VS Code Update

1.  When you update your local VS Code, the first connection attempt will download a **new server executable** (`code-<new-hash>`) to the remote host. The connection will fail again due to the GLIBC issue.
2.  You just need to log into the remote host and **run `./auto_patch_vscode.sh` again**.
3.  The script will automatically find the new executable and perform the swap operation for it.
4.  The issue is resolved, and VS Code can connect again.

This automation script simplifies a complex manual process into a single "fix-it" command that you can run whenever needed.
